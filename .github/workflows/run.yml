name: arXiv-daily-ai-enhanced
on:
  schedule:
    - cron: "03 19 * * *"
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # --------------------------
      # æ­¥éª¤1ï¼šå®‰è£…Minicondaï¼ˆä¿®å¤å‚æ•°çº¦æŸï¼šæŒ‡å®šæ¿€æ´»çŽ¯å¢ƒï¼‰
      # --------------------------
      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: "3.10"  # ä¿ç•™æœ‰æ•ˆPythonç‰ˆæœ¬
          miniconda-version: "latest"
          use-only-tar-bz2: false  # ä¿®å¤ï¼šç¦ç”¨è¯¥é€‰é¡¹ï¼ˆé¿å…é—æ¼åŒ…ç´¢å¼•ï¼‰
          conda-remove-defaults: false  # ä¿ç•™é»˜è®¤æ¸ é“
          activate-environment: "base"  # ä¿®å¤ï¼šæŒ‡å®šæ¿€æ´»baseçŽ¯å¢ƒï¼ˆæ»¡è¶³å‚æ•°çº¦æŸï¼‰
          # ä¸æŒ‡å®šenvironment-fileï¼Œé¿å…è‡ªåŠ¨åˆ›å»ºé¢å¤–çŽ¯å¢ƒ

      # --------------------------
      # æ­¥éª¤2ï¼šéªŒè¯CondaåŸºç¡€é…ç½®+æ¸…ç†ç¼“å­˜
      # --------------------------
      - name: Verify Conda installation and clean cache
        shell: bash -l {0}  # å¿…é¡»å¸¦-l {0}ï¼Œç¡®ä¿åŠ è½½CondaçŽ¯å¢ƒå˜é‡ï¼ˆæ¿€æ´»baseï¼‰
        run: |
          # éªŒè¯Condaç‰ˆæœ¬å’ŒbaseçŽ¯å¢ƒæ¿€æ´»çŠ¶æ€
          echo "=== CondaåŸºç¡€ä¿¡æ¯ ==="
          conda --version
          conda info | grep "active environment"  # åº”æ˜¾ç¤ºbaseçŽ¯å¢ƒ
          
          # æ¸…ç†ç¼“å­˜ï¼ˆé¿å…æ—§ç¼“å­˜å¯¼è‡´çš„ä¾èµ–é—®é¢˜ï¼‰
          echo -e "\n=== æ¸…ç†Condaç¼“å­˜ ==="
          conda clean --all -y --quiet
          
          # ç¡®è®¤baseçŽ¯å¢ƒPythonç‰ˆæœ¬ï¼ˆåº”ä¸ŽæŒ‡å®šçš„3.10ä¸€è‡´ï¼‰
          echo -e "\n=== BaseçŽ¯å¢ƒPythonç‰ˆæœ¬ ==="
          python --version
          if ! python --version | grep -q "3.10"; then
            echo "âŒ BaseçŽ¯å¢ƒPythonç‰ˆæœ¬ä¸æ˜¯3.10ï¼Œç»ˆæ­¢æµç¨‹"
            exit 1
          fi

      # --------------------------
      # æ­¥éª¤3ï¼šåˆ›å»ºå¹¶é…ç½®ä¸¤ä¸ªç‹¬ç«‹çŽ¯å¢ƒï¼ˆcrawl-env + main-envï¼‰
      # --------------------------
      - name: Create and configure isolated environments
        shell: bash -l {0}  # åŠ è½½CondaçŽ¯å¢ƒï¼ŒåŸºäºŽbaseåˆ›å»ºæ–°çŽ¯å¢ƒ
        run: |
          # 1. åˆ›å»ºçˆ¬å–ä¸“ç”¨çŽ¯å¢ƒï¼ˆcrawl-envï¼‰
          echo "=== åˆ›å»ºçˆ¬å–çŽ¯å¢ƒï¼ˆcrawl-envï¼‰ ==="
          # æ£€æŸ¥çŽ¯å¢ƒæ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤åˆ›å»ºæŠ¥é”™
          if conda info --envs | grep -q "crawl-env"; then
            echo "â„¹ï¸ crawl-envå·²å­˜åœ¨ï¼Œåˆ é™¤åŽé‡å»º"
            conda env remove -n crawl-env -y
          fi
          # æŒ‡å®špython=3.10ï¼Œä¸ŽbaseçŽ¯å¢ƒç‰ˆæœ¬ä¸€è‡´ï¼ˆå‡å°‘ä¾èµ–å†²çªï¼‰
          if ! conda create -n crawl-env python=3.10 -y; then
            echo "âŒ çˆ¬å–çŽ¯å¢ƒåˆ›å»ºå¤±è´¥"
            exit 1
          fi
          # æ¿€æ´»çŽ¯å¢ƒï¼ˆå¿…é¡»æ˜¾å¼æ¿€æ´»ï¼ŒbaseçŽ¯å¢ƒä¸åŒ…å«çˆ¬å–ä¾èµ–ï¼‰
          conda activate crawl-env || { echo "âŒ æ— æ³•æ¿€æ´»crawl-env"; exit 1; }
          
          # å®‰è£…çˆ¬å–ä¾èµ–ï¼ˆä¼˜å…ˆCondaæ¸ é“ï¼Œç¼ºå¤±åŒ…ç”¨pipï¼‰
          echo -e "\n=== å®‰è£…çˆ¬å–ä¾èµ– ==="
          conda install -c conda-forge pip requests -y  # requestsä»Žconda-forgeå®‰è£…æ›´ç¨³å®š
          pip install pymed==0.8.9 arxiv==2.1.3  # pymed/arxivä»…PyPIæœ‰ï¼Œç”¨pipå®‰è£…
          
          # è®°å½•çŽ¯å¢ƒPythonè·¯å¾„ï¼ˆä¾›åŽç»­æ­¥éª¤ä½¿ç”¨ï¼‰
          export CRAWL_PYTHON="$(which python)"
          echo "çˆ¬å–çŽ¯å¢ƒPythonè·¯å¾„ï¼š$CRAWL_PYTHON"
          echo "CRAWL_PYTHON=$CRAWL_PYTHON" >> $GITHUB_ENV
          
          # éªŒè¯ä¾èµ–å®‰è£…ï¼ˆç¡®ä¿å…³é”®åŒ…å¯ç”¨ï¼‰
          echo -e "\n=== çˆ¬å–çŽ¯å¢ƒå…³é”®ä¾èµ–éªŒè¯ ==="
          if ! python -c "import pymed; import arxiv; import requests"; then
            echo "âŒ çˆ¬å–çŽ¯å¢ƒä¾èµ–å¯¼å…¥å¤±è´¥"
            pip list | grep -E "pymed|arxiv|requests"  # æ‰“å°åŒ…ç‰ˆæœ¬è¾…åŠ©æŽ’æŸ¥
            exit 1
          fi
          echo "âœ… çˆ¬å–çŽ¯å¢ƒä¾èµ–éªŒè¯é€šè¿‡"

          # 2. åˆ›å»ºä¸»çŽ¯å¢ƒï¼ˆmain-envï¼‰
          echo -e "\n=== åˆ›å»ºä¸»çŽ¯å¢ƒï¼ˆmain-envï¼‰ ==="
          conda deactivate  # é€€å‡ºå‰ä¸€ä¸ªçŽ¯å¢ƒï¼Œé¿å…å†²çª
          if conda info --envs | grep -q "main-env"; then
            echo "â„¹ï¸ main-envå·²å­˜åœ¨ï¼Œåˆ é™¤åŽé‡å»º"
            conda env remove -n main-env -y
          fi
          if ! conda create -n main-env python=3.10 -y; then
            echo "âŒ ä¸»çŽ¯å¢ƒåˆ›å»ºå¤±è´¥"
            exit 1
          fi
          conda activate main-env || { echo "âŒ æ— æ³•æ¿€æ´»main-env"; exit 1; }
          
          # å®‰è£…ä¸»çŽ¯å¢ƒä¾èµ–ï¼ˆscrapyä»Žconda-forgeå®‰è£…ï¼Œé¿å…ç¼–è¯‘é—®é¢˜ï¼‰
          echo -e "\n=== å®‰è£…ä¸»çŽ¯å¢ƒä¾èµ– ==="
          conda install -c conda-forge pip scrapy==2.12.0 -y
          pip install langchain==0.3.20 langchain-openai==0.3.9 openai==1.66.3
          
          # åŒæ­¥requirements.txtï¼ˆå¦‚æœ‰ï¼‰
          if [ -f "requirements.txt" ]; then
            echo -e "\n=== å®‰è£…requirements.txtä¾èµ– ==="
            pip install -r requirements.txt || { echo "âŒ requirements.txtå®‰è£…å¤±è´¥"; exit 1; }
          fi
          
          # è®°å½•ä¸»çŽ¯å¢ƒPythonè·¯å¾„
          export MAIN_PYTHON="$(which python)"
          echo "ä¸»çŽ¯å¢ƒPythonè·¯å¾„ï¼š$MAIN_PYTHON"
          echo "MAIN_PYTHON=$MAIN_PYTHON" >> $GITHUB_ENV
          
          # éªŒè¯ä¸»çŽ¯å¢ƒä¾èµ–
          echo -e "\n=== ä¸»çŽ¯å¢ƒå…³é”®ä¾èµ–éªŒè¯ ==="
          if ! python -c "import scrapy; import langchain; import openai"; then
            echo "âŒ ä¸»çŽ¯å¢ƒä¾èµ–å¯¼å…¥å¤±è´¥"
            pip list | grep -E "scrapy|langchain|openai"
            exit 1
          fi
          echo "âœ… ä¸»çŽ¯å¢ƒä¾èµ–éªŒè¯é€šè¿‡"

      # --------------------------
      # æ­¥éª¤4ï¼šarXivçˆ¬å–ï¼ˆä½¿ç”¨crawl-envï¼‰
      # --------------------------
      - name: Crawl arXiv papers (crawl-env)
        id: crawl_step
        shell: bash -l {0}
        run: |
          # æ˜¾å¼æ¿€æ´»çˆ¬å–çŽ¯å¢ƒï¼ˆé¿å…ä½¿ç”¨baseçŽ¯å¢ƒï¼‰
          conda activate crawl-env || { echo "âŒ æ— æ³•æ¿€æ´»crawl-env"; exit 1; }
          
          # å‡†å¤‡æ—¥æœŸå’Œè¾“å‡ºç›®å½•ï¼ˆç¡®ä¿ç›®å½•å­˜åœ¨ï¼‰
          today=$(date -u "+%Y-%m-%d")
          mkdir -p data
          output_file="data/${today}.jsonl"
          echo -e "\n=== å¼€å§‹çˆ¬å– $today çš„arXivè®ºæ–‡ ==="

          # åˆ é™¤æ—§æ–‡ä»¶ï¼ˆé¿å…æ•°æ®é‡å¤ï¼‰
          if [ -f "$output_file" ]; then
            echo "ðŸ—‘ï¸ åˆ é™¤æ—§æ–‡ä»¶ï¼š$output_file"
            rm "$output_file"
          fi

          # é…ç½®çŽ¯å¢ƒå˜é‡å¹¶è¿è¡Œçˆ¬å–è„šæœ¬
          cd daily_arxiv || { echo "âŒ æœªæ‰¾åˆ°daily_arxivç›®å½•"; exit 1; }
          export OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          export OPENAI_BASE_URL=${{ secrets.OPENAI_BASE_URL }}
          export LANGUAGE="${{ vars.LANGUAGE }}"
          export CATEGORIES="${{ vars.CATEGORIES }}"
          export MODEL_NAME="${{ vars.MODEL_NAME }}"
          export OUTPUT_FILE="../$output_file"

          echo "=== è¿è¡Œçˆ¬å–è„šæœ¬ ==="
          # ä½¿ç”¨çˆ¬å–çŽ¯å¢ƒçš„Pythonè·¯å¾„ï¼Œç¡®ä¿çŽ¯å¢ƒæ­£ç¡®
          ${{ env.CRAWL_PYTHON }} daily_arxiv/spiders/arxiv.py || { echo "âŒ çˆ¬å–è„šæœ¬è¿è¡Œå¤±è´¥"; exit 1; }

          # éªŒè¯çˆ¬å–ç»“æžœ
          if [ ! -f "../$output_file" ]; then
            echo "âŒ çˆ¬å–å¤±è´¥ï¼šæœªç”Ÿæˆ $output_file"
            exit 1
          fi
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
          if [ ! -s "../$output_file" ]; then
            echo "âš ï¸ çˆ¬å–æ–‡ä»¶ä¸ºç©ºï¼š$output_file"
            exit 1
          fi
          echo -e "\nâœ… çˆ¬å–å®Œæˆï¼Œæ–‡ä»¶å¤§å°ï¼š$(du -sh ../$output_file | cut -f1)"
          echo "crawl_date=$today" >> $GITHUB_OUTPUT

      # --------------------------
      # æ­¥éª¤5ï¼šåŽ»é‡æ£€æŸ¥ï¼ˆä½¿ç”¨main-envï¼‰
      # --------------------------
      - name: Check duplicates (main-env)
        id: dedup_check
        shell: bash -l {0}
        run: |
          # åˆ‡æ¢åˆ°ä¸»çŽ¯å¢ƒ
          conda deactivate
          conda activate main-env || { echo "âŒ æ— æ³•æ¿€æ´»main-env"; exit 1; }
          
          echo "=== å¼€å§‹åŽ»é‡æ£€æŸ¥ ==="
          cd daily_arxiv || { echo "âŒ æœªæ‰¾åˆ°daily_arxivç›®å½•"; exit 1; }
          
          # å…è®¸è„šæœ¬è¿”å›žéž0 exit codeï¼ˆç”¨äºŽåˆ¤æ–­ç»“æžœï¼‰
          set +e
          ${{ env.MAIN_PYTHON }} daily_arxiv/check_stats.py
          dedup_exit_code=$?
          set -e

          # æ ¹æ®é€€å‡ºç åˆ¤æ–­ç»“æžœï¼ˆéœ€ä¸Žcheck_stats.pyé€»è¾‘åŒ¹é…ï¼‰
          echo "åŽ»é‡æ£€æŸ¥é€€å‡ºç ï¼š$dedup_exit_code"
          case $dedup_exit_code in
            0)
              echo "has_new_content=true" >> $GITHUB_OUTPUT
              echo "âœ… æ£€æµ‹åˆ°æ–°å†…å®¹"
              ;;
            1)
              echo "has_new_content=false" >> $GITHUB_OUTPUT
              echo "skip_reason=no_new_content" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ æ— æ–°å†…å®¹ï¼Œè·³è¿‡åŽç»­æ­¥éª¤"
              ;;
            2)
              echo "has_new_content=false" >> $GITHUB_OUTPUT
              echo "skip_reason=processing_error" >> $GITHUB_OUTPUT
              echo "âŒ åŽ»é‡æ£€æŸ¥å‡ºé”™ï¼Œç»ˆæ­¢å·¥ä½œæµ"
              exit 1
              ;;
            *)
              echo "has_new_content=false" >> $GITHUB_OUTPUT
              echo "skip_reason=unknown_error" >> $GITHUB_OUTPUT
              echo "âŒ æœªçŸ¥é€€å‡ºç  $dedup_exit_codeï¼Œç»ˆæ­¢å·¥ä½œæµ"
              exit 1
              ;;
          esac

      # --------------------------
      # æ­¥éª¤6ï¼šAIå¢žå¼ºï¼ˆmain-envï¼Œä»…å½“æœ‰æ–°å†…å®¹æ—¶è¿è¡Œï¼‰
      # --------------------------
      - name: AI Enhancement (main-env)
        if: steps.dedup_check.outputs.has_new_content == 'true'
        shell: bash -l {0}
        run: |
          conda activate main-env || { echo "âŒ æ— æ³•æ¿€æ´»main-env"; exit 1; }
          
          today=${{ steps.crawl_step.outputs.crawl_date }}
          input_file="data/${today}.jsonl"
          echo "=== å¼€å§‹AIå¢žå¼ºï¼š$input_file ==="

          # æ£€æŸ¥è¾“å…¥æ–‡ä»¶å­˜åœ¨æ€§
          if [ ! -f "$input_file" ]; then
            echo "âŒ çˆ¬å–æ–‡ä»¶ä¸å­˜åœ¨ï¼š$input_file"
            exit 1
          fi

          cd ai || { echo "âŒ æœªæ‰¾åˆ°aiç›®å½•"; exit 1; }
          export OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          export OPENAI_BASE_URL=${{ secrets.OPENAI_BASE_URL }}
          export LANGUAGE="${{ vars.LANGUAGE }}"
          export MODEL_NAME="${{ vars.MODEL_NAME }}"

          # è¿è¡ŒAIå¢žå¼ºè„šæœ¬ï¼ˆä½¿ç”¨ä¸»çŽ¯å¢ƒPythonï¼‰
          ${{ env.MAIN_PYTHON }} enhance.py --data "../$input_file" || { echo "âŒ AIå¢žå¼ºå¤±è´¥"; exit 1; }
          
          # éªŒè¯è¾“å‡ºæ–‡ä»¶
          ai_output_file="../data/${today}_AI_enhanced_${LANGUAGE}.jsonl"
          if [ ! -f "$ai_output_file" ]; then
            echo "âŒ AIå¢žå¼ºæœªç”Ÿæˆè¾“å‡ºæ–‡ä»¶ï¼š$ai_output_file"
            exit 1
          fi
          if [ ! -s "$ai_output_file" ]; then
            echo "âš ï¸ AIå¢žå¼ºæ–‡ä»¶ä¸ºç©ºï¼š$ai_output_file"
            exit 1
          fi
          echo "âœ… AIå¢žå¼ºå®Œæˆï¼Œè¾“å‡ºæ–‡ä»¶ï¼š$ai_output_file"

      # --------------------------
      # æ­¥éª¤7ï¼šMarkdownè½¬æ¢ï¼ˆmain-envï¼Œä»…å½“æœ‰æ–°å†…å®¹æ—¶è¿è¡Œï¼‰
      # --------------------------
      - name: Convert to Markdown (main-env)
        if: steps.dedup_check.outputs.has_new_content == 'true'
        shell: bash -l {0}
        run: |
          conda activate main-env || { echo "âŒ æ— æ³•æ¿€æ´»main-env"; exit 1; }
          
          today=${{ steps.crawl_step.outputs.crawl_date }}
          language="${{ vars.LANGUAGE }}"
          ai_file="data/${today}_AI_enhanced_${language}.jsonl"
          
          echo "=== å¼€å§‹Markdownè½¬æ¢ï¼š$ai_file ==="
          # æ£€æŸ¥AIå¢žå¼ºæ–‡ä»¶å­˜åœ¨æ€§
          if [ ! -f "$ai_file" ]; then
            echo "âŒ AIå¢žå¼ºæ–‡ä»¶ä¸å­˜åœ¨ï¼š$ai_file"
            exit 1
          fi
          if [ ! -s "$ai_file" ]; then
            echo "âš ï¸ AIå¢žå¼ºæ–‡ä»¶ä¸ºç©ºï¼š$ai_file"
            exit 1
          fi

          cd to_md || { echo "âŒ æœªæ‰¾åˆ°to_mdç›®å½•"; exit 1; }
          export LANGUAGE="$language"

          # è¿è¡Œè½¬æ¢è„šæœ¬
          ${{ env.MAIN_PYTHON }} convert.py --data "../$ai_file" || { echo "âŒ Markdownè½¬æ¢å¤±è´¥"; exit 1; }
          
          # éªŒè¯Markdownè¾“å‡ºï¼ˆå‡è®¾è„šæœ¬ç”ŸæˆåŒå.mdæ–‡ä»¶ï¼‰
          md_file="../data/${today}_AI_enhanced_${language}.md"
          if [ -f "$md_file" ] && [ -s "$md_file" ]; then
            echo "âœ… Markdownè½¬æ¢å®Œæˆï¼Œæ–‡ä»¶å¤§å°ï¼š$(du -sh "$md_file" | cut -f1)"
          else
            echo "âš ï¸ Markdownè¾“å‡ºæ–‡ä»¶å¼‚å¸¸ï¼ˆä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼‰ï¼š$md_file"
            exit 1
          fi

      # --------------------------
      # åŽç»­æ­¥éª¤ï¼šæ–‡ä»¶æ›´æ–°ã€æäº¤ã€æŽ¨é€
      # --------------------------
      - name: Update file list
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          echo "=== æ›´æ–°æ–‡ä»¶åˆ—è¡¨ ==="
          mkdir -p assets
          # åªä¿ç•™æœ€æ–°çš„JSONLå’ŒMDæ–‡ä»¶ï¼ˆé¿å…åˆ—è¡¨è¿‡å¤§ï¼‰
          ls -1t data/*.jsonl data/*.md 2>/dev/null | head -n 10 > assets/file-list.txt
          echo "âœ… æ–‡ä»¶åˆ—è¡¨å·²æ›´æ–°ï¼š$(wc -l < assets/file-list.txt) ä¸ªæœ€æ–°æ–‡ä»¶"

      - name: Commit and push changes
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          # é…ç½®Gitèº«ä»½ï¼ˆä½¿ç”¨ä»“åº“å˜é‡ï¼‰
          git config --global user.email "${{ vars.EMAIL }}"
          git config --global user.name "${{ vars.NAME }}"
          
          # æ£€æŸ¥å˜æ›´ï¼ˆåªè·Ÿè¸ªéœ€è¦æäº¤çš„ç›®å½•ï¼‰
          git add data/ assets/ || { echo "âš ï¸ æ— æ–‡ä»¶å¯æ·»åŠ "; exit 0; }
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ— å˜æ›´éœ€æäº¤"
            exit 0
          fi
          
          # æäº¤å¹¶æŽ¨é€ï¼ˆé‡è¯•3æ¬¡é¿å…ç½‘ç»œæ³¢åŠ¨ï¼‰
          git commit -m "update: ${{ steps.crawl_step.outputs.crawl_date }} arXiv papers (AI enhanced)"
          echo "=== æŽ¨é€å˜æ›´åˆ°GitHub ==="
          
          for i in {1..3}; do
            if git push origin main; then
              echo "âœ… æŽ¨é€æˆåŠŸï¼ˆå°è¯• $i/3ï¼‰"
              break
            else
              echo "âš ï¸ æŽ¨é€å¤±è´¥ï¼ˆå°è¯• $i/3ï¼‰ï¼Œæ‹‰å–æœ€æ–°ä»£ç é‡è¯•..."
              git pull origin main --no-edit || true  # æ‹‰å–æœ€æ–°ä»£ç é¿å…å†²çª
              if [ $i -eq 3 ]; then
                echo "âŒ 3æ¬¡å°è¯•åŽæŽ¨é€å¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹"
                exit 1
              fi
            fi
          done

      - name: Workflow summary
        run: |
          echo -e "\n=== å·¥ä½œæµæ‰§è¡Œæ€»ç»“ ==="
          echo "æ‰§è¡Œæ—¥æœŸï¼š$(date -u "+%Y-%m-%d %H:%M:%S UTC")"
          echo "æ˜¯å¦æœ‰æ–°å†…å®¹ï¼š${{ steps.dedup_check.outputs.has_new_content }}"
          if [ "${{ steps.dedup_check.outputs.has_new_content }}" = "false" ]; then
            echo "è·³è¿‡åŽŸå› ï¼š${{ steps.dedup_check.outputs.skip_reason }}"
          fi
          echo -e "\nâœ… å·¥ä½œæµæ‰§è¡Œç»“æŸ"
