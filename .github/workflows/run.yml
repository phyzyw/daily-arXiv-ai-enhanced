name: arXiv-daily-ai-enhanced
on:
  schedule:
    - cron: "03 19 * * *"
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # --------------------------
      # æ­¥éª¤1ï¼šå®‰è£…Minicondaå¹¶é…ç½®åŸºç¡€ç¯å¢ƒ
      # --------------------------
      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: 3.10
          miniconda-version: "latest"
          use-only-tar-bz2: true  # å‡å°‘ä¸‹è½½é—®é¢˜

      - name: Configure Conda and check installation
        shell: bash -l {0}
        run: |
          # éªŒè¯Condaå®‰è£…
          echo "Condaç‰ˆæœ¬ä¿¡æ¯ï¼š"
          conda --version
          
          # æ›´æ–°Condaä»¥é¿å…ç‰ˆæœ¬é—®é¢˜
          echo "æ›´æ–°Conda..."
          conda update -n base -c defaults conda -y
          
          # é…ç½®Condaæ¸ é“ä¼˜å…ˆçº§
          conda config --add channels conda-forge
          conda config --set channel_priority strict
          
          # æ¸…ç†ç¼“å­˜
          conda clean --all -y --quiet
          
          # æ˜¾ç¤ºé…ç½®ä¿¡æ¯
          conda info
          conda config --show channels

      - name: Create and configure environments
        shell: bash -l {0}
        run: |
          # 1. åˆ›å»ºçˆ¬å–ä¸“ç”¨ç¯å¢ƒï¼ˆcrawl-envï¼‰
          echo "=== åˆ›å»ºçˆ¬å–ä¸“ç”¨ç¯å¢ƒï¼ˆcrawl-envï¼‰ ==="
          if conda create -n crawl-env python=3.10 -y; then
            echo "çˆ¬å–ç¯å¢ƒåˆ›å»ºæˆåŠŸ"
          else
            echo "âŒ çˆ¬å–ç¯å¢ƒåˆ›å»ºå¤±è´¥"
            exit 1
          fi
          
          conda activate crawl-env || { echo "âŒ æ— æ³•æ¿€æ´»crawl-env"; exit 1; }
          
          # å®‰è£…ä¾èµ–åŒ…
          conda install -c conda-forge pip -y
          
          # ä½¿ç”¨pipå®‰è£…å¯èƒ½ä¸åœ¨condaæ¸ é“ä¸­çš„åŒ…
          if ! pip install pymed==0.8.9 arxiv==2.1.3 requests==2.32.5; then
            echo "âŒ çˆ¬å–ç¯å¢ƒä¾èµ–å®‰è£…å¤±è´¥"
            exit 1
          fi
          
          # è®°å½•Pythonè·¯å¾„
          export CRAWL_PYTHON="$(which python)"
          echo "çˆ¬å–ç¯å¢ƒPythonè·¯å¾„ï¼š$CRAWL_PYTHON"
          echo "CRAWL_PYTHON=$CRAWL_PYTHON" >> $GITHUB_ENV
          
          # éªŒè¯å®‰è£…
          echo "âœ… çˆ¬å–ç¯å¢ƒå·²å®‰è£…åŒ…ï¼š"
          pip list
          
          # 2. åˆ›å»ºä¸»ç¯å¢ƒï¼ˆmain-envï¼‰
          echo -e "\n=== åˆ›å»ºä¸»ç¯å¢ƒï¼ˆmain-envï¼‰ ==="
          if conda create -n main-env python=3.10 -y; then
            echo "ä¸»ç¯å¢ƒåˆ›å»ºæˆåŠŸ"
          else
            echo "âŒ ä¸»ç¯å¢ƒåˆ›å»ºå¤±è´¥"
            exit 1
          fi
          
          conda activate main-env || { echo "âŒ æ— æ³•æ¿€æ´»main-env"; exit 1; }
          
          # å®‰è£…ä¾èµ–åŒ…
          conda install -c conda-forge pip scrapy=2.12.0 -y
          
          # ä½¿ç”¨pipå®‰è£…å…¶ä»–åŒ…
          if ! pip install langchain==0.3.20 langchain-openai==0.3.9 openai==1.66.3; then
            echo "âŒ ä¸»ç¯å¢ƒä¾èµ–å®‰è£…å¤±è´¥"
            exit 1
          fi
          
          # åŒæ­¥å…¶ä»–ä¾èµ–
          if [ -f "requirements.txt" ]; then
            if ! pip install -r requirements.txt; then
              echo "âŒ requirements.txtå®‰è£…å¤±è´¥"
              exit 1
            fi
          fi
          
          # è®°å½•Pythonè·¯å¾„
          export MAIN_PYTHON="$(which python)"
          echo "ä¸»ç¯å¢ƒPythonè·¯å¾„ï¼š$MAIN_PYTHON"
          echo "MAIN_PYTHON=$MAIN_PYTHON" >> $GITHUB_ENV
          
          # éªŒè¯å®‰è£…
          echo "âœ… ä¸»ç¯å¢ƒå·²å®‰è£…åŒ…ï¼š"
          pip list

      # --------------------------
      # æ­¥éª¤2ï¼šarXivçˆ¬å–ï¼ˆä½¿ç”¨crawl-envï¼‰
      # --------------------------
      - name: Crawl arXiv papers (isolated env)
        id: crawl_step
        shell: bash -l {0}
        run: |
          # æ¿€æ´»çˆ¬å–ç¯å¢ƒ
          conda activate crawl-env || { echo "âŒ æ— æ³•æ¿€æ´»crawl-env"; exit 1; }
          
          # ä»ç¯å¢ƒå˜é‡è·å–çˆ¬å–Pythonè·¯å¾„
          CRAWL_PYTHON="${{ env.CRAWL_PYTHON }}"
          echo "=== é¢„æ£€æŸ¥çˆ¬å–ç¯å¢ƒpymedå¯¼å…¥ ==="
          
          # æ£€æŸ¥pymedæ˜¯å¦æ­£ç¡®å®‰è£…
          if python -c "import pymed; print('âœ… pymedå¯¼å…¥æˆåŠŸ')"; then
            echo "pymedé¢„æ£€æŸ¥é€šè¿‡"
          else
            echo "âŒ pymedé¢„æ£€æŸ¥å¤±è´¥ï¼Œç»ˆæ­¢çˆ¬å–"
            echo "å½“å‰ç¯å¢ƒPythonè·¯å¾„ï¼š$CRAWL_PYTHON"
            echo "å½“å‰ç¯å¢ƒå·²å®‰è£…åŒ…ï¼š"
            pip list
            exit 1
          fi

          # å‡†å¤‡æ—¥æœŸå’Œç›®å½•
          today=$(date -u "+%Y-%m-%d")
          mkdir -p data
          echo "å¼€å§‹çˆ¬å– $today çš„arXivè®ºæ–‡... / Starting to crawl $today arXiv papers..."

          # åˆ é™¤æ—§æ–‡ä»¶ï¼ˆå¦‚æœ‰ï¼‰
          if [ -f "data/${today}.jsonl" ]; then
              echo "ğŸ—‘ï¸ åˆ é™¤ç°æœ‰æ–‡ä»¶ï¼šdata/${today}.jsonl"
              rm "data/${today}.jsonl"
          fi

          # åˆ‡æ¢ç›®å½•å¹¶è®¾ç½®ç¯å¢ƒå˜é‡
          cd daily_arxiv
          export OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          export OPENAI_BASE_URL=${{ secrets.OPENAI_BASE_URL }}
          export LANGUAGE="${{ vars.LANGUAGE }}"
          export CATEGORIES="${{ vars.CATEGORIES }}"
          export MODEL_NAME="${{ vars.MODEL_NAME }}"
          export OUTPUT_FILE="../data/${today}.jsonl"

          # è¿è¡Œçˆ¬å–è„šæœ¬
          echo "=== å¼€å§‹è¿è¡Œçˆ¬å–è„šæœ¬ ==="
          python daily_arxiv/spiders/arxiv.py

          # æ£€æŸ¥çˆ¬å–ç»“æœ
          if [ ! -f "../data/${today}.jsonl" ]; then
              echo "âŒ çˆ¬å–å¤±è´¥ï¼šæœªç”Ÿæˆæ•°æ®æ–‡ä»¶"
              exit 1
          fi

          echo "crawl_date=$today" >> $GITHUB_OUTPUT
          echo "âœ… çˆ¬å–å®Œæˆï¼Œæ•°æ®æ–‡ä»¶ï¼šdata/${today}.jsonl"

      # --------------------------
      # æ­¥éª¤3ï¼šå»é‡æ£€æŸ¥ï¼ˆä½¿ç”¨main-envï¼‰
      # --------------------------
      - name: Check for duplicates (main env)
        id: dedup_check
        shell: bash -l {0}
        run: |
          # æ¿€æ´»ä¸»ç¯å¢ƒ
          conda activate main-env || { echo "âŒ æ— æ³•æ¿€æ´»main-env"; exit 1; }
          
          echo "=== å¼€å§‹å»é‡æ£€æŸ¥ï¼ˆä½¿ç”¨ä¸»ç¯å¢ƒï¼‰ ==="
          cd daily_arxiv
          set +e
          
          # è¿è¡Œå»é‡è„šæœ¬
          python daily_arxiv/check_stats.py
          dedup_exit_code=$?
          set -e

          echo "å»é‡æ£€æŸ¥é€€å‡ºç : $dedup_exit_code"
          echo "dedup_exit_code=$dedup_exit_code" >> $GITHUB_OUTPUT

          # åˆ¤æ–­æ˜¯å¦æœ‰æ–°å†…å®¹
          case $dedup_exit_code in
              0)
                  echo "has_new_content=true" >> $GITHUB_OUTPUT
                  ;;
              1)
                  echo "has_new_content=false" >> $GITHUB_OUTPUT
                  echo "skip_reason=no_new_content" >> $GITHUB_OUTPUT
                  ;;
              2)
                  echo "has_new_content=false" >> $GITHUB_OUTPUT
                  echo "skip_reason=processing_error" >> $GITHUB_OUTPUT
                  exit 1
                  ;;
              *)
                  echo "âŒ æœªçŸ¥é€€å‡ºç ï¼Œç»ˆæ­¢å·¥ä½œæµ"
                  echo "has_new_content=false" >> $GITHUB_OUTPUT
                  echo "skip_reason=unknown_error" >> $GITHUB_OUTPUT
                  exit 1
                  ;;
          esac

      # --------------------------
      # æ­¥éª¤4ï¼šAIå¢å¼ºï¼ˆä½¿ç”¨main-envï¼‰
      # --------------------------
      - name: AI Enhancement Processing (main env)
        if: steps.dedup_check.outputs.has_new_content == 'true'
        shell: bash -l {0}
        run: |
          # æ¿€æ´»ä¸»ç¯å¢ƒ
          conda activate main-env || { echo "âŒ æ— æ³•æ¿€æ´»main-env"; exit 1; }
          
          today=${{ steps.crawl_step.outputs.crawl_date }}
          echo "=== å¼€å§‹AIå¢å¼ºå¤„ç†ï¼ˆä½¿ç”¨ä¸»ç¯å¢ƒï¼‰ ==="

          cd ai
          export OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          export OPENAI_BASE_URL=${{ secrets.OPENAI_BASE_URL }}
          export LANGUAGE="${{ vars.LANGUAGE }}"
          export MODEL_NAME="${{ vars.MODEL_NAME }}"

          # è¿è¡ŒAIå¢å¼ºè„šæœ¬
          python enhance.py --data ../data/${today}.jsonl

          if [ $? -ne 0 ]; then
              echo "âŒ AIå¤„ç†å¤±è´¥"
              exit 1
          fi
          echo "âœ… AIå¢å¼ºå¤„ç†å®Œæˆ"

      # --------------------------
      # æ­¥éª¤5ï¼šMarkdownè½¬æ¢ï¼ˆä½¿ç”¨main-envï¼‰
      # --------------------------
      - name: Convert to Markdown (main env)
        if: steps.dedup_check.outputs.has_new_content == 'true'
        shell: bash -l {0}
        run: |
          # æ¿€æ´»ä¸»ç¯å¢ƒ
          conda activate main-env || { echo "âŒ æ— æ³•æ¿€æ´»main-env"; exit 1; }
          
          today=${{ steps.crawl_step.outputs.crawl_date }}
          echo "=== å¼€å§‹Markdownè½¬æ¢ï¼ˆä½¿ç”¨ä¸»ç¯å¢ƒï¼‰ ==="

          export LANGUAGE="${{ vars.LANGUAGE }}"
          cd to_md
          AI_FILE="../data/${today}_AI_enhanced_${LANGUAGE}.jsonl"

          if [ ! -f "$AI_FILE" ]; then
              echo "âŒ æœªæ‰¾åˆ°AIå¢å¼ºæ–‡ä»¶ï¼š$AI_FILE"
              exit 1
          fi

          # è¿è¡Œè½¬æ¢è„šæœ¬
          python convert.py --data "$AI_FILE"

          if [ $? -ne 0 ]; then
              echo "âŒ Markdownè½¬æ¢å¤±è´¥"
              exit 1
          fi
          echo "âœ… Markdownè½¬æ¢å®Œæˆ"

      # --------------------------
      # åç»­æ­¥éª¤ï¼ˆæ–‡ä»¶æ›´æ–°ã€æäº¤ç­‰ï¼‰
      # --------------------------
      - name: Update file list
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          echo "=== æ›´æ–°æ–‡ä»¶åˆ—è¡¨ ==="
          mkdir -p assets
          ls data/*.jsonl | sed 's|data/||' > assets/file-list.txt
          echo "âœ… æ–‡ä»¶åˆ—è¡¨æ›´æ–°å®Œæˆ"

      - name: Summary
        run: |
          if [ "${{ steps.dedup_check.outputs.has_new_content }}" = "true" ]; then
            echo "âœ… å·¥ä½œæµå®Œæˆï¼šæ–°å†…å®¹å·²å¤„ç†"
          else
            echo "â„¹ï¸ å·¥ä½œæµå®Œæˆï¼šæ— æ–°å†…å®¹ï¼ˆåŸå› ï¼š${{ steps.dedup_check.outputs.skip_reason }}ï¼‰"
          fi

      - name: Commit changes
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          git config --global user.email "${{ vars.EMAIL }}"
          git config --global user.name "${{ vars.NAME }}"
          git add .

          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ— å˜æ›´éœ€æäº¤"
            exit 0
          fi

          git commit -m "update: $(date -u '+%Y-%m-%d') arXiv papers"
          echo "âœ… å˜æ›´å·²æäº¤"

      - name: Pull latest changes and push
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          git config pull.rebase true
          git config rebase.autoStash true

          for i in {1..3}; do
            echo "æ¨é€å°è¯• $i"
            if git push origin main; then
              echo "âœ… æ¨é€æˆåŠŸ"
              break
            else
              echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œæ‹‰å–æœ€æ–°ä»£ç ..."
              git pull origin main --no-edit || true
              if [ $i -eq 3 ]; then
                echo "âŒ 3æ¬¡å°è¯•åæ¨é€å¤±è´¥"
                exit 1
              fi
            fi
          done
    
