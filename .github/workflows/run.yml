name: arXiv-daily-ai-enhanced

on:
  schedule:
    - cron: "03 19 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          # å®‰è£… uv
          curl -LsSf https://astral.sh/uv/install.sh | sh
          # åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
          uv venv
          # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
          source .venv/bin/activate
          # å¼ºåˆ¶å®‰è£… arxiv åŒ…ï¼Œç¡®ä¿ç‰ˆæœ¬ >=2.0.0
          uv pip install --force-reinstall "arxiv>=2.0.0"
          # å¦‚æœæœ‰ requirements.txt æˆ– pyproject.tomlï¼ŒåŒæ­¥å…¶ä»–ä¾èµ–
          uv sync || true  # ä½¿ç”¨ || true é¿å… requirements.txt ç¼ºå¤±å¯¼è‡´å¤±è´¥
          # åˆ—å‡ºå·²å®‰è£…çš„åŒ…ä»¥ä¾›è°ƒè¯•
          pip list > installed_packages.txt
          echo "å·²å®‰è£…çš„ Python åŒ…ï¼š"
          cat installed_packages.txt

      - name: Crawl arXiv papers
        id: crawl_step
        run: |
          source .venv/bin/activate
          # æŠ“å–å‰ä¸€å¤©çš„è®ºæ–‡ï¼ˆä¾‹å¦‚ï¼Œè¿è¡Œæ—¶ 09-20 æŠ“å– 09-19ï¼‰
          today=$(date -u -d "1 day ago" "+%Y-%m-%d")
          echo "å¼€å§‹çˆ¬å–å‰ä¸€å¤© $today çš„ arXiv è®ºæ–‡..."
          # æ£€æŸ¥ä»Šæ—¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨ï¼Œå¦‚å­˜åœ¨åˆ™åˆ é™¤
          if [ -f "data/${today}.jsonl" ]; then
            echo "ğŸ—‘ï¸ å‘ç°å‰ä¸€å¤©æ–‡ä»¶å·²å­˜åœ¨ï¼Œæ­£åœ¨åˆ é™¤é‡æ–°ç”Ÿæˆ..."
            rm "data/${today}.jsonl"
            echo "âœ… å·²åˆ é™¤ç°æœ‰æ–‡ä»¶ï¼šdata/${today}.jsonl"
          else
            echo "ğŸ“ å‰ä¸€å¤©æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå‡†å¤‡æ–°å»º..."
          fi
          cd daily_arxiv
          export HUGGINGFACE_API_KEY=${{ secrets.HUGGINGFACE_API_KEY }}
          export LANGUAGE="${{ vars.LANGUAGE }}"
          export CATEGORIES="${{ vars.CATEGORIES }}"
          export MODEL_NAME="${{ vars.MODEL_NAME }}"
          export OUTPUT_FILE="../data/${today}.jsonl"
          # è¿è¡Œ arxiv.pyï¼Œå‡è®¾ä½äº daily_arxiv/ ç›®å½•
          python arxiv.py >> crawl.log 2>&1
          # æ£€æŸ¥çˆ¬å–æ˜¯å¦æˆåŠŸ
          if [ ! -f "../data/${today}.jsonl" ]; then
            echo "çˆ¬å–å¤±è´¥ï¼Œæœªç”Ÿæˆæ•°æ®æ–‡ä»¶"
            echo "é”™è¯¯æ—¥å¿—ï¼š"
            cat crawl.log
            exit 1
          fi
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
          if [ ! -s "../data/${today}.jsonl" ]; then
            echo "çˆ¬å–æˆåŠŸä½†ç”Ÿæˆçš„æ–‡ä»¶ä¸ºç©º"
            echo "é”™è¯¯æ—¥å¿—ï¼š"
            cat crawl.log
            exit 1
          fi
          echo "crawl_date=$today" >> $GITHUB_OUTPUT
          echo "çˆ¬å–å®Œæˆ"

      - name: Check for duplicates
        id: dedup_check
        run: |
          source .venv/bin/activate
          echo "æ‰§è¡Œå»é‡æ£€æŸ¥..."
          cd daily_arxiv
          # æ‰§è¡Œå»é‡æ£€æŸ¥è„šæœ¬
          set +e  # æš‚æ—¶å…è®¸å‘½ä»¤å¤±è´¥
          python check_stats.py
          dedup_exit_code=$?
          set -e  # æ¢å¤ä¸¥æ ¼æ¨¡å¼
          echo "å»é‡æ£€æŸ¥é€€å‡ºç : $dedup_exit_code"
          echo "dedup_exit_code=$dedup_exit_code" >> $GITHUB_OUTPUT
          case $dedup_exit_code in
            0)
              echo "has_new_content=true" >> $GITHUB_OUTPUT
              ;;
            1)
              echo "has_new_content=false" >> $GITHUB_OUTPUT
              echo "skip_reason=no_new_content" >> $GITHUB_OUTPUT
              ;;
            2)
              echo "has_new_content=false" >> $GITHUB_OUTPUT
              echo "skip_reason=processing_error" >> $GITHUB_OUTPUT
              exit 1
              ;;
            *)
              echo "âŒ æœªçŸ¥é€€å‡ºç ï¼Œåœæ­¢å·¥ä½œæµ"
              echo "has_new_content=false" >> $GITHUB_OUTPUT
              echo "skip_reason=unknown_error" >> $GITHUB_OUTPUT
              exit 1
              ;;
          esac

      - name: AI Enhancement Processing
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          source .venv/bin/activate
          today=${{ steps.crawl_step.outputs.crawl_date }}
          echo "å¼€å§‹ AI å¢å¼ºå¤„ç†..."
          cd ai
          export HUGGINGFACE_API_KEY=${{ secrets.HUGGINGFACE_API_KEY }}
          export LANGUAGE="${{ vars.LANGUAGE }}"
          export MODEL_NAME="${{ vars.MODEL_NAME }}"
          python enhance.py --data ../data/${today}.jsonl
          # æ£€æŸ¥ AI å¤„ç†æ˜¯å¦æˆåŠŸ
          if [ $? -ne 0 ]; then
            echo "AI å¤„ç†å¤±è´¥"
            exit 1
          fi
          echo "AI å¢å¼ºå¤„ç†å®Œæˆ"

      - name: Convert to Markdown
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          source .venv/bin/activate
          today=${{ steps.crawl_step.outputs.crawl_date }}
          echo "è½¬æ¢ä¸º Markdown æ ¼å¼..."
          export LANGUAGE="${{ vars.LANGUAGE }}"
          cd to_md
          AI_FILE="../data/${today}_AI_enhanced_${LANGUAGE}.jsonl"
          if [ -f "$AI_FILE" ]; then
            echo "ä½¿ç”¨ AI å¢å¼ºæ–‡ä»¶è¿›è¡Œè½¬æ¢..."
            python convert.py --data "$AI_FILE"
          else
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° AI å¢å¼ºæ–‡ä»¶"
            echo "AI æ–‡ä»¶: $AI_FILE"
            exit 1
          fi
          # æ£€æŸ¥è½¬æ¢æ˜¯å¦æˆåŠŸ
          if [ $? -ne 0 ]; then
            echo "Markdown è½¬æ¢å¤±è´¥"
            exit 1
          fi
          echo "Markdown è½¬æ¢å®Œæˆ"

      - name: Update file list
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          echo "æ›´æ–°æ–‡ä»¶åˆ—è¡¨..."
          ls data/*.jsonl | sed 's|data/||' > assets/file-list.txt
          echo "æ–‡ä»¶åˆ—è¡¨æ›´æ–°å®Œæˆ"

      - name: Summary
        run: |
          if [ "${{ steps.dedup_check.outputs.has_new_content }}" = "true" ]; then
            echo "âœ… å·¥ä½œæµå®Œæˆï¼šå»é‡å‘ç°æ–°å†…å®¹å¹¶æˆåŠŸå¤„ç†"
          else
            case "${{ steps.dedup_check.outputs.skip_reason }}" in
              "no_new_content")
                echo "â„¹ï¸ å·¥ä½œæµå®Œæˆï¼šå»é‡åæ— æ–°å†…å®¹"
                ;;
              "processing_error")
                echo "âš ï¸ å·¥ä½œæµå®Œæˆï¼šå»é‡å¤„ç†å‡ºé”™"
                ;;
              "unknown_error")
                echo "âš ï¸ å·¥ä½œæµå®Œæˆï¼šæœªçŸ¥é”™è¯¯"
                ;;
              *)
                echo "â„¹ï¸ å·¥ä½œæµå®Œæˆï¼šæœªçŸ¥åŸå› è·³è¿‡å¤„ç†"
                ;;
            esac
          fi

      - name: Commit changes
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          git config --global user.email "${{ vars.EMAIL }}"
          git config --global user.name "${{ vars.NAME }}"
          git add .
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
            exit 0
          fi
          git commit -m "update: $(date -u '+%Y-%m-%d') arXiv papers"
          echo "å˜æ›´å·²æäº¤"

      - name: Pull latest changes and push
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          # è®¾ç½® Git é…ç½®ä»¥å¤„ç†è‡ªåŠ¨åˆå¹¶
          git config pull.rebase true
          git config rebase.autoStash true
          # å°è¯•æ¨é€ï¼Œå¦‚æœå¤±è´¥åˆ™æ‹‰å–å¹¶é‡è¯•
          for i in {1..3}; do
            echo "æ¨é€å°è¯• $i"
            if git push origin main; then
              echo "æ¨é€æˆåŠŸ"
              break
            else
              echo "æ¨é€å¤±è´¥ï¼Œæ‹‰å–æœ€æ–°å˜æ›´..."
              git pull origin main --no-edit || true
              if [ $i -eq 3 ]; then
                echo "3 æ¬¡å°è¯•åæ¨é€å¤±è´¥"
                exit 1
              fi
            fi
          done
