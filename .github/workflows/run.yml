name: arXiv-daily-ai-enhanced
on:
  schedule:
    - cron: "03 19 * * *"  # UTCæ—¶é—´ï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘å¼€å…³
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (uv + virtual env + pymed)
        run: |
          # 1. å®‰è£… uv åŒ…ç®¡ç†å™¨
          curl -LsSf https://astral.sh/uv/install.sh | sh
          # 2. åˆ›å»ºå¹¶æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼ˆUVä¼šè‡ªåŠ¨å¤„ç†ç¯å¢ƒå˜é‡ï¼Œæ— éœ€æ‰‹åŠ¨sourceï¼‰
          uv venv .venv
          # 3. ä¼˜å…ˆå®‰è£… pymedï¼ˆé¿å…åç»­ä¾èµ–å†²çªï¼‰
          uv pip install pymed==0.8.9
          # 4. å®‰è£… arxiv åŒ…ï¼ˆç¡®ä¿ç‰ˆæœ¬å…¼å®¹ï¼Œé¿å…æ—§ç‰ˆæœ¬é—®é¢˜ï¼‰
          uv pip install arxiv==2.1.3
          # 5. åŒæ­¥å…¶ä»–ä¾èµ–ï¼ˆå¦‚ requirements.txt/pyproject.tomlï¼Œè‹¥æœ‰åˆ™å®‰è£…ï¼‰
          if [ -f "requirements.txt" ]; then
            uv pip install -r requirements.txt
          elif [ -f "pyproject.toml" ]; then
            uv sync
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ä¾èµ–æ–‡ä»¶ï¼ˆrequirements.txt/pyproject.tomlï¼‰ï¼Œä»…å®‰è£…æ ¸å¿ƒåŒ…"
          fi
          # 6. è¾“å‡ºå·²å®‰è£…åŒ…åˆ—è¡¨ï¼Œä¾¿äºè°ƒè¯•
          uv pip list > installed_packages.txt
          echo "âœ… å·²å®‰è£…çš„ Python åŒ…ï¼š"
          cat installed_packages.txt

      - name: Crawl arXiv papers
        id: crawl_step
        run: |
          # å…³é”®ï¼šä½¿ç”¨ uv run è‡ªåŠ¨æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼ˆæ— éœ€æ‰‹åŠ¨ sourceï¼‰
          uv run -p .venv python -c "import pymed; print('âœ… pymed å¯¼å…¥æˆåŠŸ')"  # é¢„æ£€æŸ¥
          
          today=$(date -u "+%Y-%m-%d")
          echo "å¼€å§‹çˆ¬å– $today çš„arXivè®ºæ–‡... / Starting to crawl $today arXiv papers..."

          # ç¡®ä¿ data ç›®å½•å­˜åœ¨ï¼ˆé¿å…åˆ›å»ºæ–‡ä»¶æ—¶ç›®å½•ä¸å­˜åœ¨æŠ¥é”™ï¼‰
          mkdir -p data
          
          # æ£€æŸ¥ä»Šæ—¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨ï¼Œå¦‚å­˜åœ¨åˆ™åˆ é™¤
          if [ -f "data/${today}.jsonl" ]; then
              echo "ğŸ—‘ï¸ å‘ç°ä»Šæ—¥æ–‡ä»¶å·²å­˜åœ¨ï¼Œæ­£åœ¨åˆ é™¤é‡æ–°ç”Ÿæˆ... / Found existing today's file, deleting for fresh start..."
              rm "data/${today}.jsonl"
              echo "âœ… å·²åˆ é™¤ç°æœ‰æ–‡ä»¶ï¼šdata/${today}.jsonl / Deleted existing file: data/${today}.jsonl"
          else
              echo "ğŸ“ ä»Šæ—¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå‡†å¤‡æ–°å»º... / Today's file doesn't exist, ready to create new one..."
          fi

          # åˆ‡æ¢ç›®å½•å¹¶è®¾ç½®ç¯å¢ƒå˜é‡
          cd daily_arxiv
          export OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          export OPENAI_BASE_URL=${{ secrets.OPENAI_BASE_URL }}
          export LANGUAGE="${{ vars.LANGUAGE }}"
          export CATEGORIES="${{ vars.CATEGORIES }}"
          export MODEL_NAME="${{ vars.MODEL_NAME }}"
          export OUTPUT_FILE="../data/${today}.jsonl"

          # ä½¿ç”¨ uv run è¿è¡Œè„šæœ¬ï¼ˆè‡ªåŠ¨æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼‰
          uv run -p ../.venv python daily_arxiv/spiders/arxiv.py

          # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†æ•°æ®æ–‡ä»¶
          if [ ! -f "../data/${today}.jsonl" ]; then
              echo "âŒ çˆ¬å–å¤±è´¥ï¼Œæœªç”Ÿæˆæ•°æ®æ–‡ä»¶ / Crawling failed, no data file generated"
              exit 1
          fi

          echo "crawl_date=$today" >> $GITHUB_OUTPUT
          echo "âœ… çˆ¬å–å®Œæˆ / Crawling completed"

      - name: Check for duplicates
        id: dedup_check
        run: |
          # ä½¿ç”¨ uv run æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
          echo "æ‰§è¡Œå»é‡æ£€æŸ¥... / Performing intelligent deduplication check..."

          cd daily_arxiv
          set +e  # å…è®¸è„šæœ¬è¿”å›é0é€€å‡ºç 
          uv run -p ../.venv python daily_arxiv/check_stats.py
          dedup_exit_code=$?
          set -e  # æ¢å¤ä¸¥æ ¼æ¨¡å¼

          echo "å»é‡æ£€æŸ¥é€€å‡ºç : $dedup_exit_code / Dedup check exit code: $dedup_exit_code"
          echo "dedup_exit_code=$dedup_exit_code" >> $GITHUB_OUTPUT

          # æ ¹æ®é€€å‡ºç åˆ¤æ–­æ˜¯å¦æœ‰æ–°å†…å®¹
          case $dedup_exit_code in
              0)
                  echo "has_new_content=true" >> $GITHUB_OUTPUT
                  ;;
              1)
                  echo "has_new_content=false" >> $GITHUB_OUTPUT
                  echo "skip_reason=no_new_content" >> $GITHUB_OUTPUT
                  ;;
              2)
                  echo "has_new_content=false" >> $GITHUB_OUTPUT
                  echo "skip_reason=processing_error" >> $GITHUB_OUTPUT
                  exit 1
                  ;;
              *)
                  echo "âŒ æœªçŸ¥é€€å‡ºç ï¼Œåœæ­¢å·¥ä½œæµ / Unknown exit code, stop workflow"
                  echo "has_new_content=false" >> $GITHUB_OUTPUT
                  echo "skip_reason=unknown_error" >> $GITHUB_OUTPUT
                  exit 1
                  ;;
          esac

      - name: AI Enhancement Processing
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          # ä½¿ç”¨ uv run æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
          today=${{ steps.crawl_step.outputs.crawl_date }}
          echo "å¼€å§‹AIå¢å¼ºå¤„ç†... / Starting AI enhancement processing..."

          cd ai
          export OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          export OPENAI_BASE_URL=${{ secrets.OPENAI_BASE_URL }}
          export LANGUAGE="${{ vars.LANGUAGE }}"
          export MODEL_NAME="${{ vars.MODEL_NAME }}"

          uv run -p ../.venv python enhance.py --data ../data/${today}.jsonl

          if [ $? -ne 0 ]; then
              echo "âŒ AIå¤„ç†å¤±è´¥ / AI processing failed"
              exit 1
          fi
          echo "âœ… AIå¢å¼ºå¤„ç†å®Œæˆ / AI enhancement processing completed"

      - name: Convert to Markdown
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          # ä½¿ç”¨ uv run æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
          today=${{ steps.crawl_step.outputs.crawl_date }}
          echo "è½¬æ¢ä¸ºMarkdownæ ¼å¼... / Converting to Markdown format..."

          export LANGUAGE="${{ vars.LANGUAGE }}"
          cd to_md
          AI_FILE="../data/${today}_AI_enhanced_${LANGUAGE}.jsonl"

          # æ£€æŸ¥AIå¢å¼ºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$AI_FILE" ]; then
              echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°AIå¢å¼ºæ–‡ä»¶ / Error: AI enhanced file not found"
              echo "AIæ–‡ä»¶è·¯å¾„: $AI_FILE"
              exit 1
          fi

          uv run -p ../.venv python convert.py --data "$AI_FILE"

          if [ $? -ne 0 ]; then
              echo "âŒ Markdownè½¬æ¢å¤±è´¥ / Markdown conversion failed"
              exit 1
          fi
          echo "âœ… Markdownè½¬æ¢å®Œæˆ / Markdown conversion completed"

      - name: Update file list
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          echo "æ›´æ–°æ–‡ä»¶åˆ—è¡¨... / Updating file list..."
          mkdir -p assets  # ç¡®ä¿assetsç›®å½•å­˜åœ¨
          ls data/*.jsonl | sed 's|data/||' > assets/file-list.txt
          echo "âœ… æ–‡ä»¶åˆ—è¡¨æ›´æ–°å®Œæˆ / File list updated"

      - name: Summary
        run: |
          # è¾“å‡ºå·¥ä½œæµæ€»ç»“
          if [ "${{ steps.dedup_check.outputs.has_new_content }}" = "true" ]; then
            echo "âœ… å·¥ä½œæµå®Œæˆï¼šå»é‡å‘ç°æ–°å†…å®¹å¹¶æˆåŠŸå¤„ç† / Workflow completed: Smart deduplication found new content and processed successfully"
          else
            case "${{ steps.dedup_check.outputs.skip_reason }}" in
              "no_new_content")
                echo "â„¹ï¸ å·¥ä½œæµå®Œæˆï¼šå»é‡åæ— æ–°å†…å®¹ / Workflow completed: No new content after smart deduplication"
                ;;
              "processing_error")
                echo "âš ï¸ å·¥ä½œæµå®Œæˆï¼šå»é‡å¤„ç†å‡ºé”™ / Workflow completed: Deduplication processing error"
                ;;
              "unknown_error")
                echo "âš ï¸ å·¥ä½œæµå®Œæˆï¼šæœªçŸ¥é”™è¯¯ / Workflow completed: Unknown error"
                ;;
              *)
                echo "â„¹ï¸ å·¥ä½œæµå®Œæˆï¼šæœªçŸ¥åŸå› è·³è¿‡å¤„ç† / Workflow completed: Skipped for unknown reason"
                ;;
            esac
          fi

      - name: Commit changes
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          # é…ç½®Gitèº«ä»½å¹¶æäº¤å˜æ›´
          git config --global user.email "${{ vars.EMAIL }}"
          git config --global user.name "${{ vars.NAME }}"
          git add .

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰å˜æ›´éœ€è¦æäº¤ / No changes to commit"
            exit 0
          fi

          git commit -m "update: $(date -u '+%Y-%m-%d') arXiv papers"
          echo "âœ… å˜æ›´å·²æäº¤ / Changes committed"

      - name: Pull latest changes and push
        if: steps.dedup_check.outputs.has_new_content == 'true'
        run: |
          # é…ç½®Gitæ‹‰å–ç­–ç•¥ï¼Œé¿å…å†²çª
          git config pull.rebase true
          git config rebase.autoStash true

          # é‡è¯•æœºåˆ¶ï¼š3æ¬¡æ¨é€å°è¯•
          for i in {1..3}; do
            echo "æ¨é€å°è¯• $i / Push attempt $i"
            if git push origin main; then
              echo "âœ… æ¨é€æˆåŠŸ / Push successful"
              break
            else
              echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œæ‹‰å–æœ€æ–°å˜æ›´... / Push failed, pulling latest changes..."
              git pull origin main --no-edit || true  # æ‹‰å–æœ€æ–°ä»£ç 
              if [ $i -eq 3 ]; then
                echo "âŒ 3æ¬¡å°è¯•åæ¨é€å¤±è´¥ / Failed to push after 3 attempts"
                exit 1
              fi
            fi
          done
